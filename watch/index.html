<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://pokemogukunns.github.io/keiryouka/css/pure-min.css">
  <link rel="stylesheet" href="https://pokemogukunns.github.io/keiryouka/css/grids-responsive-min.css">
  <link rel="stylesheet" href="https://pokemogukunns.github.io/keiryouka/css/ionicons.min.css">
  <link rel="stylesheet" href="https://pokemogukunns.github.io/keiryouka/css/default.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/main.js" async></script>
  <script src="/cache.js" async></script>
</head>
<body class="no-theme">
  <div class="pure-g"> 
    <div class="pure-u-1 pure-u-md-2-24"></div> 
    <div class="pure-u-1 pure-u-md-20-24" id="contents"> 
      <div class="pure-g navbar h-box"> 
        <div class="pure-u-1 pure-u-md-12-24 searchbar">
          <a href="./requestform">新機能の要望やバグ報告</a><br> 
          <a href="./bbs">掲示板</a>
          <form class="pure-form" action="/github-yuki/search/" method="get"> 
            <fieldset> 
              <input type="search" id="searchbox" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false" name="q" placeholder="検索" title="検索" value=""> 
            </fieldset> 
          </form> 
        </div> 
      </div> 
      <div id="player-container" class="h-box"> 
        <video style="outline:none;width:100%;background-color:#000;" id="player" controls>
          <source src="{% if proxy == 'True' %}/thumbnail?v=${videoId}{% else %}https://img.youtube.com/vi/${videoId}/0.jpg{% endif %}">
        </video>
      </div> 
           <div class="h-box"> <h1>{{ videotitle }}</h1> </div> <div class="pure-g"> 
        <div class="pure-u-1 pure-u-lg-1-5"> 
          <a href="{{ videourls[0] }}" target="_blank">ダウンロード</a><br>
          <a href="javascript:{navigator.share({title: '動画を共有',text: '{{videotitle}}',url: location.protocol+'//'+document.domain+'/watch?v={{ videoid }}'+'&t='+Math.floor(document.getElementById('player').currentTime),})}">現時点の動画を共有</a><br>
          <a href="javascript:{navigator.share({title: '動画を共有',text: '{{videotitle}}',url: location.href,})}">動画を共有</a><br> 
          <hr> </div> <div class="pure-u-1 pure-u-lg-3-5">
            <div class="h-box">
            <a href="/github-yuki/channel#{{authorid}}" style="display:block;width:fit-content;width:-moz-fit-content">
              <div class="channel-profile">
                
                <img id="channelIcon" src="" alt="チャンネルアイコン" width="50" height="50" style="display:none;">
                
                <h2 id="channelName"><span id="channelName"></span></h2> </div> </a> 
            <div id="description-box"> <div id="descriptionWrapper">{{ description | safe}}</div> </div>
            <hr> <div id="comments"> </div> </div> </div> 
        <div class="pure-u-1 pure-u-lg-1-5">
          <!--自動再生<input type="checkbox" id="autonext" onchange="checkautoplay()"><br>-->
          ループ再生<input type="checkbox" id="loop" onchange="changeloop()"> {% for re in res %} <a href="/github-yuki/watch?v={{ re['id'] }}">
            <div class="thumbnail">
              <img loading="lazy" class="thumbnail" src="{% if proxy == "True" %}/thumbnail?v={{ re['id']}}{% else %}https://img.youtube.com/vi/${videoId}/0.jpg{% endif %}">
            </div>
            <p style="width:100%">{{re["title"]}}</p> </a><br> 
          <a href="/github-yuki/channel#{{re['authorId']}}">{{re["author"]}}</a>{% endfor %} </div> </div> </div> </div> 
    </div>
    <div class="pure-u-1 pure-u-md-2-24"></div> 
  </div>
　<script>
        // APIキーのリスト（優先順）
        const apiKeys = [
            'AIzaSyBU2xE_JHvB6wag3tMfhxXpg2Q_W8xnM-I',
            'AIzaSyDophAQuyyiBr8h0nypEwXUKozH-BEswD0',
            'AIzaSyDZNkyC-AtROwMBpLfevIvqYk-Gfi8ZOeo',
            'AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8'
        ];
        let currentKeyIndex = 0; // 現在使用中のAPIキーのインデックス

        // URLクエリパラメータから値を取得する関数
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // チャンネル情報を取得する関数
        function fetchChannelInfo(channelId) {
            const apiKey = apiKeys[currentKeyIndex]; // 現在のAPIキーを使用
            const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelId}&key=${apiKey}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) { // もしリクエストが失敗した場合
                        throw new Error('APIリクエストに失敗しました');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.items && data.items.length > 0) {
                        const channel = data.items[0].snippet;
                        document.getElementById('channel-name').textContent = channel.title;
                        const iconElement = document.getElementById('channel-icon');
                        iconElement.src = channel.thumbnails.default.url;
                        iconElement.style.display = 'block'; // アイコンを表示
                    } else {
                        document.getElementById('channel-name').textContent = 'チャンネルが見つかりませんでした';
                    }
                })
                .catch(error => {
                    console.error('エラーが発生しました:', error);
                    if (currentKeyIndex < apiKeys.length - 1) {
                        // 次のAPIキーを試す
                        currentKeyIndex++;
                        console.log(`APIキーを切り替えています。次のキー: ${currentKeyIndex + 1}`);
                        fetchChannelInfo(channelId); // 再度リクエスト
                    } else {
                        // すべてのAPIキーが失敗した場合
                        document.getElementById('channel-name').textContent = 'すべてのAPIキーが失敗しました';
                    }
                });
        }

        // ページ読み込み時にクエリパラメータからビデオIDを取得してチャンネル情報を表示
        window.onload = function() {
            const videoId = getQueryParam('v');
            if (videoId) {
                fetchChannelInfo(videoId);
            } else {
                document.getElementById('channel-name').textContent = 'ビデオIDが見つかりません';
            }
        };
    </script>
  
  <script>
    $('#searchbox').autocomplete({
      source: function (request, response) {
        var url = "/suggest?keyword=" + encodeURIComponent(request.term);
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.onload = function() {
          if (xhr.status === 200) {
            response(JSON.parse(xhr.responseText));
          }
        };
        xhr.send();
      },
      delay: 300
    });
  </script>
</body>
</html>
